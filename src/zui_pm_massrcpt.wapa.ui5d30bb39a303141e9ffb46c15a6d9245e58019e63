sap.ui.define([                                                                                                                                                                                                                                                
	"sap/ui/core/mvc/Controller",                                                                                                                                                                                                                                 
	"com/toray/massreceipt/libs/DataServices",                                                                                                                                                                                                                    
	"sap/ui/model/json/JSONModel",                                                                                                                                                                                                                                
	"sap/m/MessagePopover",                                                                                                                                                                                                                                       
	"sap/m/MessageItem",                                                                                                                                                                                                                                          
	"sap/m/MessageToast",                                                                                                                                                                                                                                         
	"sap/ui/core/routing/History",                                                                                                                                                                                                                                
	"sap/ui/core/Fragment"                                                                                                                                                                                                                                        
], function (Controller, DataServices, JSONModel, MessagePopover, MessageItem, MessageToast, History, Fragment) {                                                                                                                                              
	"use strict";                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
	return Controller.extend("com.toray.massreceipt.controller.BaseController", {                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
		onInit: function () {                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
			window.This = this;                                                                                                                                                                                                                                         
			this._oDataServices = new DataServices();                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
			//For Message Popover                                                                                                                                                                                                                                       
			this._MessageManager = sap.ui.getCore().getMessageManager();                                                                                                                                                                                                
			this._MessageManager.registerObject(this.getView(), true);                                                                                                                                                                                                  
			this.getView().setModel(this._MessageManager.getMessageModel(), "message"); //Add a model with name "message" to the view                                                                                                                                   
			this.createMessagePopover(true); //Create a Message Popover if not already created                                                                                                                                                                          
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onNavBack: function () {                                                                                                                                                                                                                                     
			const oHistory = History.getInstance();                                                                                                                                                                                                                     
			let sPreviousHash = oHistory.getPreviousHash();                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
			if (sPreviousHash !== undefined) {                                                                                                                                                                                                                          
				window.history.go(-1);                                                                                                                                                                                                                                     
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		getResourceText: function (sText, aParam) {                                                                                                                                                                                                                  
			return this.getView().getModel("i18n").getResourceBundle().getText(sText, aParam);                                                                                                                                                                          
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                            
		 * @param {string} [sModelName]&nbsp;                                                                                                                                                                                                                        
		 * @returns {sap.ui.model.Model}                                                                                                                                                                                                                             
		 */                                                                                                                                                                                                                                                          
		getModel: function (sModelName) {                                                                                                                                                                                                                            
			return this.getView().getModel(sModelName);                                                                                                                                                                                                                 
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 *&nbsp;                                                                                                                                                                                                                                                     
		 * @param {String} sModelName&nbsp;                                                                                                                                                                                                                          
		 * @param {sap.ui.model.Model} oModel&nbsp;                                                                                                                                                                                                                  
		 */                                                                                                                                                                                                                                                          
		setModel: function (oModel, sModelName) {                                                                                                                                                                                                                    
			this.getView().setModel(oModel, sModelName);                                                                                                                                                                                                                
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		getDataServices: function () {                                                                                                                                                                                                                               
			return this._oDataServices;                                                                                                                                                                                                                                 
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		getRouter: function () {                                                                                                                                                                                                                                     
			return this.getOwnerComponent().getRouter();                                                                                                                                                                                                                
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
		//Load a dialog popup and return a promise                                                                                                                                                                                                                   
		loadDialogPopup: function ({                                                                                                                                                                                                                                 
			name,                                                                                                                                                                                                                                                       
			dialog                                                                                                                                                                                                                                                      
		}) {                                                                                                                                                                                                                                                         
			return new Promise((resolve, reject) => {                                                                                                                                                                                                                   
				if (!dialog) {                                                                                                                                                                                                                                             
					Fragment.load({                                                                                                                                                                                                                                           
						name: name,                                                                                                                                                                                                                                              
						controller: this                                                                                                                                                                                                                                         
					}).then(dialog => {                                                                                                                                                                                                                                       
						this.getView().addDependent(dialog);                                                                                                                                                                                                                     
						resolve(dialog);                                                                                                                                                                                                                                         
					});                                                                                                                                                                                                                                                       
				} else { //Déjà chargée&nbsp;                                                                                                                                                                                                                              
					resolve(dialog);                                                                                                                                                                                                                                          
				}                                                                                                                                                                                                                                                          
			});                                                                                                                                                                                                                                                         
		},&nbsp;&nbsp;                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
		// Display a MessageToast (Success)&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                  
		displayMessageToastSuccess: function (text) {                                                                                                                                                                                                                
			MessageToast.show(text, {                                                                                                                                                                                                                                   
				duration: 2000                                                                                                                                                                                                                                             
			});                                                                                                                                                                                                                                                         
			$(".sapMMessageToast").addClass("sapMMessageToastSuccess ");                                                                                                                                                                                                
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		// Display a MessageToast (Info)&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                     
		displayMessageToastInfo: function (text) {                                                                                                                                                                                                                   
			MessageToast.show(text, {                                                                                                                                                                                                                                   
				duration: 2000                                                                                                                                                                                                                                             
			});                                                                                                                                                                                                                                                         
			$(".sapMMessageToast").addClass("sapMMessageToastInfo ");                                                                                                                                                                                                   
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		// Display a MessageToast (Warning)&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                  
		displayMessageToastWarning: function (text) {                                                                                                                                                                                                                
			MessageToast.show(text, {                                                                                                                                                                                                                                   
				duration: 2000                                                                                                                                                                                                                                             
			});                                                                                                                                                                                                                                                         
			$(".sapMMessageToast").addClass("sapMMessageToastWarning ");                                                                                                                                                                                                
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		// Display a MessageToast (Danger)&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                   
		displayMessageToastDanger: function (text) {                                                                                                                                                                                                                 
			MessageToast.show(text, {                                                                                                                                                                                                                                   
				duration: 2000                                                                                                                                                                                                                                             
			});                                                                                                                                                                                                                                                         
			$(".sapMMessageToast").addClass("sapMMessageToastDanger ");                                                                                                                                                                                                 
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		// Display a MessageToast (Note)&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                     
		displayMessageToastNote: function (text) {                                                                                                                                                                                                                   
			MessageToast.show(text, {                                                                                                                                                                                                                                   
				duration: 2000                                                                                                                                                                                                                                             
			});                                                                                                                                                                                                                                                         
			$(".sapMMessageToast").addClass("sapMMessageToastNote ");                                                                                                                                                                                                   
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
		// ███    ███ ███████ ███████ ███████  █████   ██████  ███████     ██████   ██████  ██████   ██████  ██    ██ ███████ ██████&nbsp;&nbsp;                                                                                                                     
		// ████  ████ ██      ██      ██      ██   ██ ██       ██          ██   ██ ██    ██ ██   ██ ██    ██ ██    ██ ██      ██   ██&nbsp;                                                                                                                          
		// ██ ████ ██ █████   ███████ ███████ ███████ ██   ███ █████       ██████  ██    ██ ██████  ██    ██ ██    ██ █████   ██████&nbsp;&nbsp;                                                                                                                     
		// ██  ██  ██ ██           ██      ██ ██   ██ ██    ██ ██          ██      ██    ██ ██      ██    ██  ██  ██  ██      ██   ██&nbsp;                                                                                                                          
		// ██      ██ ███████ ███████ ███████ ██   ██  ██████  ███████     ██       ██████  ██       ██████    ████   ███████ ██   ██&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                          
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 * Recursive function : set selected and focus on the lime item that contains a control                                                                                                                                                                      
		 * @param {*} oControl&nbsp;                                                                                                                                                                                                                                 
		 */                                                                                                                                                                                                                                                          
		focusAndSelectTableItem(oControl){                                                                                                                                                                                                                           
			const oParent = oControl?.getParent();                                                                                                                                                                                                                      
			if(oParent==null) return;                                                                                                                                                                                                                                   
			if(oParent.getMetadata().getName()==="sap.m.ColumnListItem"){                                                                                                                                                                                               
				oParent.setSelected(true);                                                                                                                                                                                                                                 
				oParent.focus();								                                                                                                                                                                                                                                   
			} else {                                                                                                                                                                                                                                                    
				this.focusAndSelectTableItem(oParent);                                                                                                                                                                                                                     
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 *  Create the Message Popover                                                                                                                                                                                                                               
		 **/                                                                                                                                                                                                                                                         
		createMessagePopover: function (bInit) {                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
			this.oMessagePopover = Object.getPrototypeOf(this.constructor).oMessagePopover; //Get static instance of Message Popover if already generated                                                                                                               
                                                                                                                                                                                                                                                               
			//Instanciate the Message Popover if not already done                                                                                                                                                                                                       
			if (bInit === true || typeof this.oMessagePopover !== "object") {                                                                                                                                                                                           
				this.oMessagePopover = new MessagePopover({                                                                                                                                                                                                                
					activeTitlePress: (oEvent)=> { //triggered at click on the message active title link                                                                                                                                                                      
						const oItem = oEvent.getParameter("item");                                                                                                                                                                                                               
						const oMessage = oItem.getBindingContext("message").getObject(); //Get the message instance                                                                                                                                                              
						const oControl = sap.ui.getCore().byId(oMessage.getControlId()); //Get the control associated to the message                                                                                                                                             
						if (oControl) {                                                                                                                                                                                                                                          
							setTimeout(()=>{								                                                                                                                                                                                                                                
								this.focusAndSelectTableItem(oControl);								                                                                                                                                                                                                        
								oControl.focus();                                                                                                                                                                                                                                      
							}, 100);							                                                                                                                                                                                                                                         
						}                                                                                                                                                                                                                                                        
					},                                                                                                                                                                                                                                                        
					items: {                                                                                                                                                                                                                                                  
						path: "message>/",                                                                                                                                                                                                                                       
						template: new MessageItem({                                                                                                                                                                                                                              
							title: "{message>message}",							&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                  
							activeTitle: {                                                                                                                                                                                                                                          
								parts: [{                                                                                                                                                                                                                                              
									path: 'message>controlIds'                                                                                                                                                                                                                            
								}],                                                                                                                                                                                                                                                    
								formatter: this.isPositionable                                                                                                                                                                                                                         
							}, //controlId is set Only for controls bound to a model                                                                                                                                                                                                
							type: "{= (${message>type}==='Information'?'Success':${message>type}) }", //Convert Information to Success                                                                                                                                              
							description: "{message>message}"                                                                                                                                                                                                                        
						})                                                                                                                                                                                                                                                       
					}                                                                                                                                                                                                                                                         
				});                                                                                                                                                                                                                                                        
				Object.getPrototypeOf(this.constructor).oMessagePopover = this.oMessagePopover; //Store the instance as a static property of BaseController                                                                                                                
                                                                                                                                                                                                                                                               
				this.oMessagePopover._oMessageView.setGroupItems(true);                                                                                                                                                                                                    
			}                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			this.byId("messagePopoverBtn")?.addDependent(this.oMessagePopover);                                                                                                                                                                                         
			                                                                                                                                                                                                                                                            
			// this.oMessagePopover.getBinding("items")?.attachChange(function (oEvent) {                                                                                                                                                                               
			// 	let aMessages = this.getModel("message").getData();                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
			// 	if (aMessages.length > 0) {                                                                                                                                                                                                                             
			// 		this.openMessagePopover();                                                                                                                                                                                                                             
			// 	} else {                                                                                                                                                                                                                                                
			// 		this.closeMessagePopover();                                                                                                                                                                                                                            
			// 	}                                                                                                                                                                                                                                                       
			// }.bind(this));                                                                                                                                                                                                                                           
			                                                                                                                                                                                                                                                            
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		/**                                                                                                                                                                                                                                                          
		 *  Used for Message Popover : is a message positionable on the screen                                                                                                                                                                                       
		 */                                                                                                                                                                                                                                                          
		isPositionable: function (sControlIds) {                                                                                                                                                                                                                     
			// Such a hook can be used by the application to determine if a control can be found/reached on the page and navigated to.	                                                                                                                                 
			if (sControlIds && sControlIds.length > 0) {                                                                                                                                                                                                                
				return true;                                                                                                                                                                                                                                               
			}                                                                                                                                                                                                                                                           
			return false;                                                                                                                                                                                                                                               
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		handleMessagePopoverPress: function (oEvent) {                                                                                                                                                                                                               
			if (!this.oMessagePopover) {                                                                                                                                                                                                                                
				this.createMessagePopover();                                                                                                                                                                                                                               
			}                                                                                                                                                                                                                                                           
			this.oMessagePopover.toggle(oEvent.getSource());                                                                                                                                                                                                            
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		openMessagePopover: function () {                                                                                                                                                                                                                            
			let aMessages = this.getModel("message").getData();                                                                                                                                                                                                         
			if (aMessages.length > 0) {                                                                                                                                                                                                                                 
				if (!this.oMessagePopover) {                                                                                                                                                                                                                               
					this.createMessagePopover();                                                                                                                                                                                                                              
				}                                                                                                                                                                                                                                                          
				const oControl = this.oMessagePopover.getEventingParent();                                                                                                                                                                                                 
				if (oControl.getVisible()) {                                                                                                                                                                                                                               
					this.oMessagePopover.openBy(oControl);                                                                                                                                                                                                                    
				}                                                                                                                                                                                                                                                          
			}			                                                                                                                                                                                                                                                        
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		closeMessagePopover: function () {                                                                                                                                                                                                                           
			if (this.oMessagePopover) {                                                                                                                                                                                                                                 
				this.oMessagePopover.close();                                                                                                                                                                                                                              
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		removeAllMessages: function(){                                                                                                                                                                                                                               
			this._MessageManager.removeAllMessages();                                                                                                                                                                                                                   
		}                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
	});                                                                                                                                                                                                                                                           
});                                                                                                                                                                                                                                                            